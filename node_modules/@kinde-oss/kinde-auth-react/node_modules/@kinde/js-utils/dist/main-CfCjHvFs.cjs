"use strict";var j=(e=>(e.email="email",e.profile="profile",e.openid="openid",e.offline_access="offline",e))(j||{}),E=(e=>(e.none="none",e.create="create",e.login="login",e))(E||{}),L=(e=>(e.organizationDetails="organization_details",e.organizationMembers="organization_members",e.organizationPlanDetails="organization_plan_details",e.organizationPaymentDetails="organization_payment_details",e.organizationPlanSelection="organization_plan_selection",e.profile="profile",e))(L||{}),q=(e=>(e.organizationDetails="organization_details",e.organizationMembers="organization_members",e.organizationPlanDetails="organization_plan_details",e.organizationPaymentDetails="organization_payment_details",e.organizationPlanSelection="organization_plan_selection",e.profile="profile",e))(q||{}),x=(e=>(e.logout="logout",e.login="login",e.register="registration",e.token="token",e.profile="profile",e))(x||{}),S=(e=>(e[e.refreshToken=0]="refreshToken",e[e.cookie=1]="cookie",e))(S||{});const z=e=>{const t=c=>btoa(c).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");if(e instanceof ArrayBuffer){const c=new Uint8Array(e),a=String.fromCharCode(...c);return t(a)}const n=new TextEncoder().encode(e),o=String.fromCharCode(...n);return t(o)},I=(e=28)=>{if(crypto){const t=new Uint8Array(e/2);return crypto.getRandomValues(t),Array.from(t,G).join("")}else return Z(e)};function G(e){return e.toString(16).padStart(2,"0")}function Z(e=28){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let r="";const n=t.length;for(let o=0;o<e;o++)r+=t.charAt(Math.floor(Math.random()*n));return r}const Q=e=>{e=e.split("?")[1];const t=new URLSearchParams(e);return{accessToken:t.get("access_token"),idToken:t.get("id_token"),expiresIn:+(t.get("expires_in")||0)}},C=e=>e.replace(/\/$/,""),B=(e,t=!1)=>{const r=Array.isArray(e.audience)?e.audience.join(" "):e.audience||"",n={login_hint:e.loginHint,is_create_org:e.isCreateOrg?.toString(),connection_id:e.connectionId,redirect_uri:e.redirectURL?t?e.redirectURL:C(e.redirectURL):void 0,audience:r,scope:e.scope?.join(" ")||"email profile openid offline",prompt:e.prompt,lang:e.lang,org_code:e.orgCode,org_name:e.orgName,has_success_page:e.hasSuccessPage?.toString(),workflow_deployment_id:e.workflowDeploymentId,supports_reauth:e.supportsReauth?.toString(),plan_interest:e.planInterest};return Object.keys(n).forEach(o=>n[o]===void 0&&delete n[o]),n},b=e=>typeof e!="object"||e===null?e:Array.isArray(e)?e.map(t=>b(t)):Object.fromEntries(Object.entries(e).map(([t,r])=>[t.replace(/_([a-z])/g,(n,o)=>o.toUpperCase()),b(r)])),X=["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gclid","click_id","hsa_acc","hsa_cam","hsa_grp","hsa_ad","hsa_src","hsa_tgt","hsa_kw","hsa_mt","hsa_net","hsa_ver","match_type","keyword","device","ad_group_id","campaign_id","creative","network","ad_position","fbclid","li_fat_id","msclkid","twclid","ttclid"],Y=async(e,t=x.login,r,n)=>{const o=`${e}/oauth2/auth`,c=$();if(r.reauthState)try{const u=b(JSON.parse(atob(r.reauthState)));r={...r,...u},delete r.reauthState}catch(u){const h=u instanceof Error?u.message:"Unknown error";throw new Error(`Error handing reauth state: ${h}`)}if(!r.clientId)throw new Error("Error generating auth URL: Client ID missing");const a={client_id:r.clientId,response_type:r.responseType||"code",...B(r,n?.disableUrlSanitization)};r.state||(r.state=I(32)),c&&c.setSessionItem(s.state,r.state),a.state=r.state,r.nonce||(r.nonce=I(16)),a.nonce=r.nonce,c&&c.setSessionItem(s.nonce,r.nonce);let f="";if(r.codeChallenge)a.code_challenge=r.codeChallenge;else{const{codeVerifier:u,codeChallenge:h}=await O();f=u,c&&c.setSessionItem(s.codeVerifier,u),a.code_challenge=h}a.code_challenge_method="S256",r.codeChallengeMethod&&(a.code_challenge_method=r.codeChallengeMethod),!r.prompt&&t===x.register&&(a.prompt=E.create),r.properties&&Object.keys(r.properties).forEach(u=>{if(!X.includes(u)){console.warn("Unsupported Property for url generation: ",u);return}const h=r.properties?.[u];h!==void 0&&(a[u]=h)});const l=new URLSearchParams(a).toString();return{url:new URL(`${o}?${l}`),state:a.state,nonce:a.nonce,codeChallenge:a.code_challenge,codeVerifier:f}};async function O(){const e=I(52),t=new TextEncoder().encode(e);let r="";if(!crypto)r=z(btoa(e));else{const n=await crypto.subtle.digest("SHA-256",t);r=z(n)}return{codeVerifier:e,codeChallenge:r}}let T;function D(e,t){if(U(),typeof window>"u")throw new Error("setRefreshTimer requires a browser environment");if(e<=0)throw new Error("Timer duration must be positive");T=window.setTimeout(t,Math.min(e*1e3-1e4,864e5))}function U(){T!==void 0&&(window.clearTimeout(T),T=void 0)}const w={framework:"",frameworkVersion:"",sdkVersion:""},M=async()=>{await $()?.removeItems(s.state,s.nonce,s.codeVerifier)},K=async({urlParams:e,domain:t,clientId:r,redirectURL:n,autoRefresh:o=!1,onRefresh:c})=>{const a=e.get("state"),f=e.get("code");if(!a||!f)return console.error("Invalid state or code"),{success:!1,error:"Invalid state or code"};const l=$();if(!l)return console.error("No active storage found"),{success:!1,error:"Authentication storage is not initialized"};(!w.framework||!w.frameworkVersion)&&console.warn("Framework and version not set. Please set the framework and version in the config object");const u=await l.getSessionItem(s.state);if(a!==u)return console.error("Invalid state"),{success:!1,error:`Invalid state; supplied ${a}, expected ${u}`};const h=await l.getSessionItem(s.codeVerifier);if(h===null)return console.error("Code verifier not found"),{success:!1,error:"Code verifier not found"};const F={"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"};w.framework&&(F["Kinde-SDK"]=`${w.framework}/${w.sdkVersion}/${w.frameworkVersion}/Javascript`);const J={method:"POST",...!i.useInsecureForRefreshToken&&v(t)?{credentials:"include"}:{},headers:new Headers(F),body:new URLSearchParams({client_id:r,code:f,code_verifier:h,grant_type:"authorization_code",redirect_uri:n})};let p;U();try{if(p=await fetch(`${t}/oauth2/token`,J),!p?.ok){const k=await p.text();return console.error("Token exchange failed:",p.status,k),{success:!1,error:`Token exchange failed: ${p.status} - ${k}`}}}catch(k){return M(),console.error("Token exchange failed:",k),{success:!1,error:`Token exchange failed: ${k}`}}const d=await p.json(),V=_();V&&V.setItems({[s.accessToken]:d.access_token,[s.idToken]:d.id_token,[s.refreshToken]:d.refresh_token}),(i.useInsecureForRefreshToken||!v(t))&&l.setSessionItem(s.refreshToken,d.refresh_token),o&&D(d.expires_in,async()=>{y({domain:t,clientId:r,onRefresh:c})}),M();const W=(k=>(k.search="",k))(new URL(window.location.toString()));return window.history.replaceState(window.history.state,"",W),!d.access_token||!d.id_token||!d.refresh_token?{success:!1,error:"No access token received"}:{success:!0,[s.accessToken]:d.access_token,[s.idToken]:d.id_token,[s.refreshToken]:d.refresh_token}};function ee(e){const r=document.cookie.split("; ").find(n=>n.startsWith(`${e}=`));if(!r)return null;try{const n=r.split("=")[1];return n?decodeURIComponent(n):null}catch(n){return console.error(`Error parsing cookie ${e}:`,n),null}}const re="_kbrte",te=async({domain:e,clientId:t})=>{if(!e)return{success:!1,error:"Domain is required for authentication check"};if(!t)return{success:!1,error:"Client ID is required for authentication check"};const r=v(e),n=i.useInsecureForRefreshToken;let o=null;return r&&!n&&(o=ee(re)),await y({domain:e,clientId:t,refreshType:o?S.cookie:S.refreshToken})},v=e=>!e.match(/^(?:https?:\/\/)?[a-zA-Z0-9][.-a-zA-Z0-9]*\.kinde\.com$/i);function P(e,t){return t<=0?[]:e.match(new RegExp(`.{1,${t}}`,"g"))||[]}var s=(e=>(e.accessToken="accessToken",e.idToken="idToken",e.refreshToken="refreshToken",e.state="state",e.nonce="nonce",e.codeVerifier="codeVerifier",e))(s||{});class A{async setItems(t){await Promise.all(Object.entries(t).map(([r,n])=>this.setSessionItem(r,n)))}async removeItems(...t){await Promise.all(t.map(r=>this.removeSessionItem(r)))}}class ne extends A{memCache={};async destroySession(){this.memCache={}}async setSessionItem(t,r){if(await this.removeSessionItem(t),typeof r=="string"){P(r,i.maxLength).forEach((n,o)=>{this.memCache[`${i.keyPrefix}${t}${o}`]=n});return}this.memCache[`${i.keyPrefix}${String(t)}0`]=r}async getSessionItem(t){if(this.memCache[`${i.keyPrefix}${String(t)}0`]===void 0)return null;let r="",n=0,o=`${i.keyPrefix}${String(t)}${n}`;for(;this.memCache[o]!==void 0;)r+=this.memCache[o],n++,o=`${i.keyPrefix}${String(t)}${n}`;return r}async removeSessionItem(t){for(const r in this.memCache)r.startsWith(`${i.keyPrefix}${String(t)}`)&&delete this.memCache[r]}}function R(e){return new Promise((t,r)=>{chrome.storage.local.get([e],function(n){chrome.runtime.lastError?r(void 0):t(n[e])})})}class oe extends A{async destroySession(){await chrome.storage.local.clear()}async setSessionItem(t,r){if(await this.removeSessionItem(t),typeof r=="string"){P(r,i.maxLength).forEach(async(n,o)=>{await chrome.storage.local.set({[`${i.keyPrefix}${t}${o}`]:n})});return}await chrome.storage.local.set({[`${i.keyPrefix}${t}0`]:r})}async getSessionItem(t){let r="",n=0,o=`${i.keyPrefix}${String(t)}${n}`;for(;await R(`${i.keyPrefix}${String(t)}${n}`)!==void 0;)r+=await R(o),n++,o=`${i.keyPrefix}${String(t)}${n}`;return r}async removeSessionItem(t){let r=0;for(;await R(`${i.keyPrefix}${String(t)}${r}`)!==void 0;)await chrome.storage.local.remove(`${i.keyPrefix}${String(t)}${r}`),r++}}class se extends A{constructor(){super(),i.useInsecureForRefreshToken&&console.warn("LocalStorage store should not be used in production")}internalItems=new Set;async destroySession(){this.internalItems.forEach(t=>{this.removeSessionItem(t)})}async setSessionItem(t,r){if(await this.removeSessionItem(t),this.internalItems.add(t),typeof r=="string"){P(r,i.maxLength).forEach((n,o)=>{localStorage.setItem(`${i.keyPrefix}${t}${o}`,n)});return}localStorage.setItem(`${i.keyPrefix}${t}0`,r)}async getSessionItem(t){if(localStorage.getItem(`${i.keyPrefix}${t}0`)===null)return null;let r="",n=0,o=`${i.keyPrefix}${String(t)}${n}`;for(;localStorage.getItem(o)!==null;)r+=localStorage.getItem(o),n++,o=`${i.keyPrefix}${String(t)}${n}`;return r}async removeSessionItem(t){let r=0;for(;localStorage.getItem(`${i.keyPrefix}${String(t)}${r}`)!==null;)localStorage.removeItem(`${i.keyPrefix}${String(t)}${r}`),r++;this.internalItems.delete(t)}}const i={keyPrefix:"kinde-",maxLength:2e3,useInsecureForRefreshToken:!1};function ae(e,t){if(!e)return null;const r=e.split(".");if(r.length!==3)return null;const n=r[1].replace(/-/g,"+").replace(/_/g,"/"),o=decodeURIComponent(atob(n).split("").map(c=>"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(o)}const m=async(e=s.accessToken)=>{const t=_();if(!t)return null;const r=await t.getSessionItem(e==="accessToken"?s.accessToken:s.idToken);if(!r)return null;const n=ae(r);return n||console.warn("No decoded token found"),n},N=async(e="accessToken")=>m(e),ie=async(e,t="accessToken")=>{const r=await N(t);return r?{name:e,value:r[e]}:null},ce=async()=>{const e=await m();return e?e.org_code||e["x-hasura-org-code"]:null},le=async(e=s.accessToken)=>{const t=_();if(!t)return null;const r=await t.getSessionItem(e==="accessToken"?s.accessToken:s.idToken);return r||null},ue=async e=>{const t=await m();if(!t)return null;const r=t.feature_flags||t["x-hasura-feature-flags"];return r?r[e]?.v??null:null},fe=async()=>{const e=await N("idToken");if(!e)return null;const{sub:t}=e;return t?{id:e.sub,givenName:e.given_name,familyName:e.family_name,email:e.email,picture:e.picture}:(console.error("No sub in idToken"),null)},de=async e=>{const t=await m();if(!t)return{permissionKey:e,orgCode:null,isGranted:!1};const r=t.permissions||[];return{permissionKey:e,orgCode:t.org_code,isGranted:!!r.includes(e)}},he=async()=>{const e=await m();if(!e)return{orgCode:null,permissions:[]};const t=e.permissions||e["x-hasura-permissions"]||[];return{orgCode:e.org_code||e["x-hasura-org-code"],permissions:t}},ge=async()=>{const e=await m("idToken");return e?!e.org_codes&&!e["x-hasura-org-codes"]?(console.warn("Org codes not found in token, ensure org codes have been included in the token customisation within the application settings"),null):e.org_codes||e["x-hasura-org-codes"]:null},me=async()=>{const e=await m();return e?!e.roles&&!e["x-hasura-roles"]?(console.warn("No roles found in token, ensure roles have been included in the token customisation within the application settings"),[]):e.roles||e["x-hasura-roles"]:[]},ke=async e=>{try{const t=await m("accessToken");if(!t)return!1;if(!t.exp)return console.error("Token does not have an expiry"),!1;const r=t.exp<Math.floor(Date.now()/1e3);return r&&e?.useRefreshToken?(await y({domain:e.domain,clientId:e.clientId})).success:!r}catch(t){return console.error("Error checking authentication:",t),!1}},y=async({domain:e,clientId:t,refreshType:r=S.refreshToken,onRefresh:n})=>{const o=f=>(n&&n(f),f);if(!e)return o({success:!1,error:"Domain is required for token refresh"});if(!t)return o({success:!1,error:"Client ID is required for token refresh"});let c="",a;if(i.useInsecureForRefreshToken||!v(e)?a=$():a=_(),r===S.refreshToken){if(!a)return o({success:!1,error:"No active storage found"});if(c=await a.getSessionItem(s.refreshToken),!c)return o({success:!1,error:"No refresh token found"})}U();try{const f=await fetch(`${C(e)}/oauth2/token`,{method:"POST",...r===S.cookie&&{credentials:"include"},headers:{"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:new URLSearchParams({...r===S.refreshToken&&{refresh_token:c},grant_type:"refresh_token",client_id:t}).toString()});if(!f.ok)return o({success:!1,error:"Failed to refresh token"});const l=await f.json();if(l.access_token){const u=_();return u?(D(l.expires_in,async()=>{y({domain:e,clientId:t,refreshType:r,onRefresh:n})}),a&&(await u.setSessionItem(s.accessToken,l.access_token),l.id_token&&await u.setSessionItem(s.idToken,l.id_token),l.refresh_token&&await a.setSessionItem(s.refreshToken,l.refresh_token)),o({success:!0,[s.accessToken]:l.access_token,[s.idToken]:l.id_token,[s.refreshToken]:l.refresh_token})):o({success:!1,error:"No active storage found"})}}catch(f){return o({success:!1,error:`No access token received: ${f}`})}return o({success:!1,error:"No access token received"})},g={secure:null,insecure:null},Se=e=>{g.secure=e},_=()=>g.secure||null,we=()=>g.secure!==null,_e=()=>{g.secure=null},pe=e=>{g.insecure=e},$=()=>g.insecure||g.secure||null,ve=()=>g.insecure!==null,ye=()=>{g.insecure=null},$e=async e=>(console.warn("Warning: generateProfileUrl is deprecated. Please use generatePortalUrl instead."),H({domain:e.domain,returnUrl:e.returnUrl,subNav:e.subNav})),H=async({domain:e,returnUrl:t,subNav:r})=>{const n=_();if(!n)throw new Error("generatePortalUrl: Active storage not found");const o=await n.getSessionItem(s.accessToken);if(!o)throw new Error("generatePortalUrl: Access Token not found");const c=new URLSearchParams({sub_nav:r||L.profile,return_url:t}),a=await fetch(`${C(e)}/account_api/v1/portal_link?${c.toString()}`,{headers:{Authorization:`Bearer ${o}`}});if(!a.ok)throw new Error(`Failed to fetch profile URL: ${a.status} ${a.statusText}`);const f=await a.json();if(!f.url||typeof f.url!="string")throw new Error("Invalid URL received from API");try{return{url:new URL(f.url)}}catch(l){throw console.error(l),new Error(`Invalid URL format received from API: ${f.url}`)}},Te={__esModule:!0,default:async()=>(await Promise.resolve().then(()=>require("./expoSecureStore-RvPT3jok.cjs"))).ExpoSecureStore};exports.ChromeStore=oe;exports.ExpoSecureStore=Te;exports.IssuerRouteTypes=x;exports.LocalStorage=se;exports.MemoryStorage=ne;exports.PortalPage=L;exports.ProfilePage=q;exports.PromptTypes=E;exports.RefreshType=S;exports.Scopes=j;exports.SessionBase=A;exports.StorageKeys=s;exports.base64UrlEncode=z;exports.checkAuth=te;exports.clearActiveStorage=_e;exports.clearInsecureStorage=ye;exports.clearRefreshTimer=U;exports.exchangeAuthCode=K;exports.extractAuthResults=Q;exports.frameworkSettings=w;exports.generateAuthUrl=Y;exports.generatePortalUrl=H;exports.generateProfileUrl=$e;exports.generateRandomString=I;exports.getActiveStorage=_;exports.getClaim=ie;exports.getClaims=N;exports.getCurrentOrganization=ce;exports.getDecodedToken=m;exports.getFlag=ue;exports.getInsecureStorage=$;exports.getPermission=de;exports.getPermissions=he;exports.getRawToken=le;exports.getRoles=me;exports.getUserOrganizations=ge;exports.getUserProfile=fe;exports.hasActiveStorage=we;exports.hasInsecureStorage=ve;exports.isAuthenticated=ke;exports.isCustomDomain=v;exports.mapLoginMethodParamsForUrl=B;exports.refreshToken=y;exports.sanitizeUrl=C;exports.setActiveStorage=Se;exports.setInsecureStorage=pe;exports.setRefreshTimer=D;exports.splitString=P;exports.storageSettings=i;
